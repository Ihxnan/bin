#!/usr/bin/env bash
set -euo pipefail

cleanup() {
    echo ""
    echo "âš ï¸  æ£€æµ‹åˆ° Ctrl+Cï¼Œæ­£åœ¨æ‰§è¡Œæ¸…ç†å·¥ä½œ..."
    rm -f *.out data.txt ans.txt test.txt
    echo "âœ…  ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤ã€‚"
    exit 1
}

trap cleanup SIGINT

echo "ğŸ”§  å¼€å§‹ç¼–è¯‘ç¨‹åº..."
g++ -std=c++17 -O3 ans.cpp -o ans.out
g++ -std=c++17 -O3 test.cpp -o test.out
g++ -std=c++17 -O3 data.cpp -o data.out
echo "âœ…  æ‰€æœ‰ç¨‹åºç¼–è¯‘æˆåŠŸï¼"
echo "--------------------"

echo "ğŸš€  å¼€å§‹è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•..."
echo "ğŸ’¡  æŒ‰ Ctrl+C å¯éšæ—¶ä¸­æ–­å¹¶æ¸…ç†ã€‚"

count=0
MAX_ATTEMPTS=100

while true; do
    ((++count))

    if [ $count -gt $MAX_ATTEMPTS ]; then
        echo "âœ…  å·²å°è¯• $MAX_ATTEMPTS æ¬¡ï¼Œæœªæ‰¾åˆ°åä¾‹ã€‚æµ‹è¯•é€šè¿‡ï¼"
        break
    fi

    echo "æ­£åœ¨è¿›è¡Œç¬¬ $count æ¬¡æµ‹è¯•..."

    echo "  - æ­£åœ¨ç”Ÿæˆæµ‹è¯•æ•°æ®..."
    ./data.out > data.txt

    echo "  - æ­£åœ¨è¿è¡Œæ ‡å‡†ç¨‹åº (ans.out)..."
    ./ans.out < data.txt > ans.txt
    echo "  - æ­£åœ¨è¿è¡Œä½ çš„ç¨‹åº (test.out)..."
    ./test.out < data.txt > test.txt

    echo "  - æ­£åœ¨æ¯”è¾ƒè¾“å‡ºç»“æœ..."
    if ! diff -q ans.txt test.txt > /dev/null; then
        echo "--------------------"
        echo "âŒ  æ‰¾åˆ°åä¾‹ï¼åœ¨ç¬¬ $count æ¬¡æµ‹è¯•ä¸­ã€‚"
        echo "ğŸ“„  æµ‹è¯•æ•°æ®å·²ä¿å­˜åˆ°: data.txt"
        echo "ğŸ“„  æ ‡å‡†è¾“å‡ºå·²ä¿å­˜åˆ°: ans.txt"
        echo "ğŸ“„  ä½ çš„è¾“å‡ºå·²ä¿å­˜åˆ°: test.txt"
        echo "--- è¯¦ç»†å·®å¼‚å¦‚ä¸‹ ---"
        diff ans.txt test.txt
        echo "--------------------"
        break
    else
        echo "  - ç¬¬ $count æ¬¡æµ‹è¯•ï¼šç»“æœä¸€è‡´ã€‚"
    fi

    echo "--------------------"
done

# --- 4. æ­£å¸¸ç»“æŸæ—¶çš„æ¸…ç† ---
echo "ğŸ”„  æµ‹è¯•ç»“æŸï¼Œæ­£åœ¨æ¸…ç†æ–‡ä»¶..."
rm -f *.out data.txt ans.txt test.txt
echo "âœ…  æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†ã€‚"
echo "ğŸ‰  è„šæœ¬è¿è¡Œå®Œæ¯•ã€‚"
